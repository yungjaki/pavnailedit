<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ö–∞–ª–µ–Ω–¥–∞—Ä - PavNailedIt</title>
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<style>
body {
  font-family: 'Roboto', sans-serif;
  background-color: #fff0f4;
  padding: 1.5rem;
}
h1 {
  text-align: center;
  color: #ff6ec4;
  margin-bottom: 1rem;
  font-size: 1.6rem;
}
#calendar {
  max-width: 900px;
  margin: 0 auto;
  background: #ffd3e8;
  padding: 1rem;
  border-radius: 20px;
  box-shadow: 0 10px 25px rgba(255,110,196,0.3);
}
.fc-event {
  background-color: #f9a1c2 !important;
  border: none !important;
  color: #fff !important;
  border-radius: 10px !important;
  padding: 2px 5px !important;
  font-size: 0.85rem !important;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.fc-day-today {
  background-color: #ff9ecd !important;
  border-radius: 15px;
}
.day-total {
  font-size: 0.8rem;
  background: #ffe4f0;
  border: 1px solid #ffb3d6;
  color: #ff3f9d;
  border-radius: 8px;
  padding: 2px 6px;
  margin-top: 2px;
  display: inline-block;
  font-weight: 600;
  box-shadow: 0 2px 6px rgba(255,110,196,0.2);
}
.tooltip {
  position: absolute;
  background: #fff;
  color: #2c2c2c;
  border: 1px solid #f9a1c2;
  border-radius: 10px;
  padding: 10px;
  font-size: 0.9rem;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  display: none;
  z-index: 1000;
  width: 220px;
}
.tooltip strong { color: #ff6ec4; }

/* üì± –ú–æ–±–∏–ª–µ–Ω –∏–∑–≥–ª–µ–¥ */
@media (max-width: 768px) {
  h1 { font-size: 1.4rem; }
  #calendar {
    padding: 0.5rem;
    border-radius: 15px;
  }
  .fc {
    font-size: 0.8rem;
  }
  .fc-toolbar-title {
    font-size: 1rem !important;
  }
  .fc-daygrid-day-top {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .day-total {
    font-size: 0.7rem;
    margin-top: 3px;
    padding: 2px 5px;
  }
  /* –ò–∑–≥–ª–µ–∂–¥–∞ –ø–æ-"card" —Å—Ç–∏–ª */
  .fc-daygrid-day-frame {
    border-radius: 10px;
    background: #ffe8f3;
    margin: 2px;
  }
}

/* üíÖ Popup –∑–∞ –º–æ–±–∏–ª–Ω–∏ */
#mobileModal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  justify-content: center;
  align-items: center;
  z-index: 2000;
}
#mobileModal .content {
  background: #fff;
  border-radius: 15px;
  padding: 20px;
  width: 80%;
  max-width: 350px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.3);
  text-align: left;
}
#mobileModal h3 {
  color: #ff6ec4;
  margin-bottom: 10px;
}
#mobileModal button {
  background: #ff6ec4;
  color: white;
  border: none;
  border-radius: 10px;
  padding: 8px 16px;
  margin-top: 10px;
  cursor: pointer;
  font-weight: 500;
}
</style>
</head>
<body>

<h1>üíÖüèª –ö–∞–ª–µ–Ω–¥–∞—Ä —Å —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏</h1>
<div id="calendar"></div>
<div class="tooltip" id="tooltip"></div>

<!-- Popup –∑–∞ –º–æ–±–∏–ª–Ω–∏ -->
<div id="mobileModal">
  <div class="content">
    <h3>üìÖ –î–µ—Ç–∞–π–ª–∏ –∑–∞ —á–∞—Å</h3>
    <div id="modalBody"></div>
    <button id="closeModal">–ó–∞—Ç–≤–æ—Ä–∏</button>
  </div>
</div>

<script>
let tooltip = document.getElementById('tooltip');
const modal = document.getElementById('mobileModal');
const modalBody = document.getElementById('modalBody');
const closeModal = document.getElementById('closeModal');

closeModal.onclick = () => modal.style.display = 'none';

async function loadBookings() {
  try {
    const res = await fetch('/api/book');
    const data = await res.json();
    return data.bookings || [];
  } catch (err) {
    console.error('‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ:', err);
    return [];
  }
}

function formatDateISO(dateStr, timeStr) {
  const [d,m,y] = dateStr.split('.');
  return `${y}-${m}-${d}T${timeStr}:00`;
}

document.addEventListener('DOMContentLoaded', async () => {
  const bookings = await loadBookings();

  const calendarEl = document.getElementById('calendar');
  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: window.innerWidth < 768 ? 'dayGridWeek' : 'dayGridMonth',
    locale: 'bg',
    height: 'auto',
    events: bookings.map(b => ({
      title: `${b.time} ‚Äî ${b.name}`,
      start: formatDateISO(b.date, b.time),
      extendedProps: { services: b.services, totalPrice: parseFloat(b.totalPrice) || 0, phone: b.phone }
    })),
    eventMouseEnter(info) {
      if (window.innerWidth < 768) return; // –±–µ–∑ tooltip –Ω–∞ –º–æ–±–∏–ª–Ω–∏
      const { services, totalPrice, phone } = info.event.extendedProps;
      tooltip.innerHTML = `
        <strong>${info.event.title}</strong><br>
        <br>üìû –¢–µ–ª–µ—Ñ–æ–Ω: ${phone || '‚Äî'}
        <br>üíÖ –£—Å–ª—É–≥–∏:
        <ul>${services.map(s => `<li>${s}</li>`).join('')}</ul>
        <p><strong>üí∞ –û–±—â–æ: ${totalPrice.toFixed(2)} –ª–≤</strong></p>
      `;
      tooltip.style.display = 'block';
      const pageWidth = document.documentElement.clientWidth;
      let left = info.jsEvent.pageX + 10;
      if (left + tooltip.offsetWidth > pageWidth - 10) {
        left = info.jsEvent.pageX - tooltip.offsetWidth - 10;
      }
      tooltip.style.left = left + 'px';
      tooltip.style.top = (info.jsEvent.pageY + 10) + 'px';
    },
    eventMouseLeave() {
      tooltip.style.display = 'none';
    },
    eventClick(info) {
      if (window.innerWidth >= 768) return; // popup —Å–∞–º–æ –∑–∞ –º–æ–±–∏–ª–Ω–∏
      const { services, totalPrice, phone } = info.event.extendedProps;
      modalBody.innerHTML = `
        <p><strong>${info.event.title}</strong></p>
        <p>üìû –¢–µ–ª–µ—Ñ–æ–Ω: ${phone || '‚Äî'}</p>
        <p>üíÖ –£—Å–ª—É–≥–∏:</p>
        <ul>${services.map(s => `<li>${s}</li>`).join('')}</ul>
        <p><strong>üí∞ –û–±—â–æ: ${totalPrice.toFixed(2)} –ª–≤</strong></p>
      `;
      modal.style.display = 'flex';
    },
    datesSet() {
      document.querySelectorAll('.day-total').forEach(el => el.remove());
      const events = calendar.getEvents();
      document.querySelectorAll('.fc-daygrid-day').forEach(dayCell => {
        const date = new Date(dayCell.getAttribute('data-date'));
        const dayEvents = events.filter(ev => {
          const evDate = ev.start;
          return evDate.getFullYear() === date.getFullYear() &&
                 evDate.getMonth() === date.getMonth() &&
                 evDate.getDate() === date.getDate();
        });
        const dayTotal = dayEvents.reduce((sum, ev) => sum + (ev.extendedProps.totalPrice || 0), 0);
        if (dayTotal > 0) {
          const label = document.createElement('div');
          label.className = 'day-total';
          label.textContent = `üí∞ ${dayTotal.toFixed(2)} –ª–≤`;
          dayCell.querySelector('.fc-daygrid-day-top')?.appendChild(label);
        }
      });
    }
  });

  calendar.render();
});
</script>

</body>
</html>
