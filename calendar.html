<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ö–∞–ª–µ–Ω–¥–∞—Ä - PavNailedIt</title>
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<style>
body {
  font-family: 'Poppins', sans-serif;
  background: linear-gradient(135deg, #ffe0ef, #fff5f8);
  min-height: 100vh;
  padding: 1.5rem;
  color: #2c2c2c;
}
h1 {
  text-align: center;
  color: #ff6ec4;
  margin-bottom: 1.5rem;
  font-weight: 600;
  text-shadow: 0 2px 8px rgba(255,110,196,0.2);
}
#calendar {
  max-width: 900px;
  margin: 0 auto;
  background: white;
  padding: 1rem;
  border-radius: 25px;
  box-shadow: 0 10px 25px rgba(255,110,196,0.2);
  overflow: hidden;
}
.fc-event {
  background: linear-gradient(135deg, #ff9ecd, #ff6ec4) !important;
  border: none !important;
  color: #fff !important;
  border-radius: 12px !important;
  padding: 3px 6px !important;
  font-size: 0.85rem;
  box-shadow: 0 2px 5px rgba(255,110,196,0.3);
  transition: transform 0.2s ease;
}
.fc-event:hover {
  transform: scale(1.05);
}
.fc-daygrid-day:hover {
  background-color: #fff0f6 !important;
  cursor: pointer;
}
.fc-daygrid-day-top {
  position: relative;
}
.day-total {
  font-size: 0.7rem;
  background: #fff3fa;
  border: 1px solid #ffb3d6;
  color: #ff3f9d;
  border-radius: 6px;
  padding: 2px 4px;
  position: absolute;
  top: 4px;
  right: 4px;
}
.tooltip {
  position: absolute;
  background: #fff;
  color: #2c2c2c;
  border: 1px solid #f9a1c2;
  border-radius: 10px;
  padding: 10px;
  font-size: 0.9rem;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  display: none;
  z-index: 1000;
  width: 220px;
}
.tooltip strong {
  color: #ff6ec4;
}
@media (max-width: 768px) {
  #calendar {
    padding: 0.5rem;
  }
  .tooltip {
    font-size: 0.8rem;
    width: 180px;
  }
}
</style>
</head>
<body>

<h1>üíÖüèª –ö–∞–ª–µ–Ω–¥–∞—Ä —Å —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏</h1>
<div id="calendar"></div>
<div class="tooltip" id="tooltip"></div>

<script>
let tooltip = document.getElementById('tooltip');

async function loadBookings() {
  try {
    const res = await fetch('/api/book');
    const data = await res.json();
    return data.bookings || [];
  } catch (err) {
    console.error('‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ:', err);
    return [];
  }
}

function formatDateISO(dateStr, timeStr) {
  const [d, m, y] = dateStr.split('.');
  return `${y}-${m}-${d}T${timeStr}:00`;
}

document.addEventListener('DOMContentLoaded', async () => {
  const bookings = await loadBookings();

  // üéØ –ì—Ä—É–ø–∏—Ä–∞–Ω–µ –Ω–∞ —Å—É–º–∏ –ø–æ –¥–∞—Ç–∞
  const dayTotals = {};
  bookings.forEach(b => {
    const key = b.date;
    const price = parseFloat(b.totalPrice) || 0;
    dayTotals[key] = (dayTotals[key] || 0) + price;
  });

  const events = bookings.map(b => ({
    title: `${b.time} ‚Äî ${b.name}`,
    start: formatDateISO(b.date, b.time),
    extendedProps: {
      services: b.services,
      totalPrice: b.totalPrice,
      phone: b.phone
    }
  }));

  const calendarEl = document.getElementById('calendar');
  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    locale: 'bg',
    height: 'auto',
    events,
    eventDidMount(info) {
      // –ù–∏—â–æ —Å–ø–µ—Ü–∏–∞–ª–Ω–æ —Ç—É–∫
    },
    eventMouseEnter(info) {
      const { services, totalPrice, phone } = info.event.extendedProps;
      tooltip.innerHTML = `
        <strong>${info.event.title}</strong><br>
        <br>üìû –¢–µ–ª–µ—Ñ–æ–Ω: ${phone || '‚Äî'}
        <br>üíÖ –£—Å–ª—É–≥–∏:
        <ul>${services.map(s => `<li>${s}</li>`).join('')}</ul>
        <p><strong>üí∞ –û–±—â–æ: ${totalPrice} –ª–≤</strong></p>
      `;
      tooltip.style.display = 'block';

      const tooltipWidth = tooltip.offsetWidth;
      const tooltipHeight = tooltip.offsetHeight;
      const pageWidth = window.innerWidth;
      const pageHeight = window.innerHeight;
      const mouseX = info.jsEvent.pageX;
      const mouseY = info.jsEvent.pageY;

      let left = mouseX + 10;
      let top = mouseY + 10;

      if (mouseX + tooltipWidth + 20 > pageWidth) {
        left = mouseX - tooltipWidth - 10;
      }
      if (mouseY + tooltipHeight + 20 > pageHeight) {
        top = mouseY - tooltipHeight - 10;
      }

      tooltip.style.left = left + 'px';
      tooltip.style.top = top + 'px';
    },
    eventMouseLeave() {
      tooltip.style.display = 'none';
    },
    datesSet() {
      // –°–ª–µ–¥ –∫–∞—Ç–æ –∫–∞–ª–µ–Ω–¥–∞—Ä–∞ —Å–µ —Ä–µ–Ω–¥–µ—Ä–∏—Ä–∞, –¥–æ–±–∞–≤—è–º–µ –¥–Ω–µ–≤–Ω–∏—Ç–µ —Å—É–º–∏ üí∞
      document.querySelectorAll('.fc-daygrid-day').forEach(dayCell => {
        const date = dayCell.getAttribute('data-date');
        const [y, m, d] = date.split('-');
        const key = `${d}.${m}.${y}`;
        if (dayTotals[key]) {
          const label = document.createElement('div');
          label.className = 'day-total';
          label.textContent = `üí∞ ${dayTotals[key]} –ª–≤`;
          dayCell.querySelector('.fc-daygrid-day-top').appendChild(label);
        }
      });
    }
  });

  calendar.render();
});
</script>

</body>
</html>
